# P2P приложение с обходом NAT

P2P приложение с реализацией NAT hole punching для UDP соединений. Поддерживает три сценария: один клиент за NAT, оба клиента за NAT в одной сети, оба клиента за NAT каждый за своим.

## Сборка

**Требования:**
- C++17 компилятор
- CMake 3.16+
- Make

**Сборка:**
```bash
cd hw_3
mkdir build
cd build
cmake ..
make
```

Исполняемый файл: `build/bin/p2p_app`

## Использование

### Запуск Rendezvous сервера

Rendezvous сервер помогает клиентам установить P2P соединение:

```bash
./p2p_app rendezvous --address 0.0.0.0 --port 8080
```

### Запуск P2P клиента

P2P клиент подключается к rendezvous серверу и устанавливает соединение с другим клиентом:

```bash
./p2p_app p2p-client --rendezvous 127.0.0.1 --rendezvous-port 8080
```

**Параметры:**
- `--address <ip>` - адрес для rendezvous сервера (по умолчанию: 0.0.0.0)
- `--port <port>` - порт для rendezvous сервера (по умолчанию: 8080)
- `--rendezvous <ip>` - адрес rendezvous сервера (для p2p-client)
- `--rendezvous-port <port>` - порт rendezvous сервера (для p2p-client, по умолчанию: 8080)
- `--help` - показать справку

## Протокол

### Команды протокола

- `REGISTER` - регистрация клиента на rendezvous сервере
- `PEER_INFO` - информация о другом пире (IP:PORT)
- `HOLE_PUNCH` - команда для начала hole punching
- `MESSAGE:<data>` - передача сообщения
- `PING` - проверка соединения
- `PONG` - ответ на PING
- `QUIT` - завершение соединения

### Алгоритм NAT Hole Punching

1. Оба клиента подключаются к rendezvous серверу
2. Каждый клиент отправляет `REGISTER` на rendezvous сервер
3. Сервер сохраняет внешние адреса клиентов (как их видит NAT)
4. Когда два клиента зарегистрированы, сервер отправляет каждому `PEER_INFO` с адресом другого клиента
5. Клиенты одновременно начинают отправлять пакеты `HOLE_PUNCH` друг другу
6. NAT "пробивает дыру" и устанавливается прямое P2P соединение
7. Клиенты общаются напрямую без участия rendezvous сервера

## Тестирование

### Подготовка

Для тестирования в различных сетевых конфигурациях можно использовать Docker с образами `cn-alpine` для создания NAT устройств и клиентов.

### Сценарий 1: Один клиент за NAT

1. Запустить rendezvous сервер на публичной машине
2. Запустить первый клиент на публичной машине
3. Запустить второй клиент за NAT устройством
4. Клиенты должны установить соединение

### Сценарий 2: Оба клиента за NAT в одной сети

1. Запустить rendezvous сервер на публичной машине
2. Запустить оба клиента за одним NAT устройством в одной локальной сети
3. Клиенты должны установить соединение напрямую

### Сценарий 3: Оба клиента за NAT, каждый за своим

1. Запустить rendezvous сервер на публичной машине
2. Запустить первый клиент за первым NAT устройством
3. Запустить второй клиент за вторым NAT устройством
4. Клиенты должны установить соединение через hole punching

### Запись сетевого трафика

Для записи трафика между NAT устройствами используйте `tcpdump`:

```bash
sudo tcpdump -i <interface> -w captures/nat_traffic.pcap port <port>
```

Анализ трафика можно выполнить с помощью `wireshark` или `tshark`:

```bash
tshark -r captures/nat_traffic.pcap
```

## Структура проекта

```
hw_3/
├── src/
│   ├── common/
│   │   ├── logger.hpp          - Система логирования
│   │   ├── protocol.hpp         - Протокол обмена сообщениями
│   │   └── socket_wrapper.hpp   - Обертка над системными сокетами
│   ├── rendezvous/
│   │   ├── rendezvous_server.hpp
│   │   └── rendezvous_server.cpp - Сервер для помощи в установлении соединения
│   ├── p2p/
│   │   ├── p2p_client.hpp
│   │   └── p2p_client.cpp       - P2P клиент с NAT hole punching
│   └── main.cpp                 - Точка входа приложения
├── CMakeLists.txt
└── README.md
```

## Объяснение NAT Hole Punching

NAT hole punching работает следующим образом:

1. **Регистрация**: Оба клиента регистрируются на rendezvous сервере, который видит их внешние адреса (после трансляции NAT)

2. **Обмен информацией**: Rendezvous сервер сообщает каждому клиенту внешний адрес другого

3. **Одновременная отправка**: Оба клиента одновременно начинают отправлять UDP пакеты друг другу на эти внешние адреса

4. **Создание маппинга**: NAT устройства создают временные маппинги для входящих пакетов, так как клиенты уже начали отправку

5. **Установление соединения**: Пакеты проходят через NAT, и устанавливается прямое P2P соединение

**Важно**: Оба клиента должны начать отправку почти одновременно, иначе NAT может отбросить пакеты как нежелательные.

## Зависимости

- C++17 стандарт
- POSIX сокеты (Linux, macOS, BSD)

## Лицензия

Учебный проект

